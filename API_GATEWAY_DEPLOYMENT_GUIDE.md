# API Gateway Deployment Guide

This guide provides step-by-step instructions for deploying the Freehold Document Sharing Platform with proper API Gateway configuration.

## Overview

The deployment fixes the following issues:
- ✅ API Gateway CORS configuration
- ✅ Lambda proxy integration
- ✅ Lambda function permissions and environment variables
- ✅ Frontend environment configuration
- ✅ End-to-end connectivity testing

## Prerequisites

- AWS CLI installed and configured
- Node.js 18.x or later
- Access to AWS Console
- S3 bucket created for file storage

## Step 1: Configure and Deploy Backend

### 1.1 Configure Lambda Environment

```bash
cd backend
node configure-lambda-env.js
```

This will generate:
- AWS CLI commands for setting environment variables
- IAM policy for Lambda function
- Lambda function configuration
- Deployment checklist

### 1.2 Deploy Lambda Function

#### Option A: Using Serverless Framework (Recommended)

```bash
cd backend

# Install dependencies
npm install

# Configure API Gateway settings
node deploy-api-gateway.js

# Deploy to AWS
npm run deploy:prod
```

#### Option B: Manual Deployment via AWS Console

1. **Create Lambda Function**:
   - Runtime: Node.js 18.x
   - Handler: `index.handler`
   - Timeout: 30 seconds
   - Memory: 512 MB

2. **Upload Code**:
   - Use `backend/freehold-api-lambda-updated.zip`
   - Or create new package: `npm run package-lambda`

3. **Set Environment Variables**:
   ```bash
   # Use the AWS CLI commands generated by configure-lambda-env.js
   aws lambda update-function-configuration \
     --function-name freehold-api \
     --environment Variables='{...}'
   ```

4. **Attach IAM Role**:
   - Use the IAM policy from `backend/aws-config/lambda-iam-policy.json`

### 1.3 Create API Gateway

1. **Create REST API**:
   - API name: `freehold-api`
   - Description: `Freehold Document Sharing API`

2. **Create Resources**:
   - Create resource: `/{proxy+}`
   - Enable proxy integration

3. **Configure Methods**:
   - Method: `ANY` for `/{proxy+}`
   - Integration type: Lambda Function
   - Lambda function: `freehold-api`
   - Use Lambda Proxy integration: ✅

4. **Enable CORS**:
   - Enable CORS on all resources
   - Access-Control-Allow-Origin: `*`
   - Access-Control-Allow-Headers: `Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Requested-With`
   - Access-Control-Allow-Methods: `GET,POST,PUT,DELETE,OPTIONS`

5. **Deploy API**:
   - Create deployment stage: `prod`
   - Note the API Gateway URL

## Step 2: Test Backend Deployment

### 2.1 Test Lambda Function

```bash
# Test Lambda directly
aws lambda invoke \
  --function-name freehold-api \
  --payload '{"httpMethod":"GET","path":"/health"}' \
  response.json

cat response.json
```

### 2.2 Test API Gateway

```bash
cd backend

# Set your API Gateway URL
export API_GATEWAY_URL=https://your-api-id.execute-api.us-east-1.amazonaws.com/prod

# Run comprehensive tests
node test-api-gateway.js
```

Expected results:
- ✅ CORS preflight successful
- ✅ Health check successful
- ✅ Authentication successful
- ✅ Protected endpoint successful

## Step 3: Configure and Deploy Frontend

### 3.1 Update Frontend Environment

```bash
cd frontend

# Interactive configuration
node configure-production-env.js
```

This will:
- Prompt for your API Gateway URL
- Update `.env.production` with correct API base URL
- Create backup of original configuration
- Optionally build the frontend

### 3.2 Manual Environment Update

Alternatively, manually edit `frontend/.env.production`:

```env
VITE_API_BASE_URL=https://your-api-id.execute-api.us-east-1.amazonaws.com/prod/api
```

### 3.3 Build and Test Frontend

```bash
cd frontend

# Install dependencies
npm install

# Build for production
npm run build

# Test build locally
npm run preview
```

### 3.4 Deploy to Amplify

#### Option A: Git-based Deployment (Recommended)

1. **Commit Changes**:
   ```bash
   git add .
   git commit -m "Configure API Gateway deployment"
   git push
   ```

2. **Amplify Console**:
   - Go to AWS Amplify Console
   - Your app should automatically redeploy
   - Monitor build logs for any issues

#### Option B: Manual Deployment

1. **Upload Build**:
   - Zip the `frontend/dist` folder
   - Upload to Amplify Console

2. **Environment Variables**:
   - Set environment variables in Amplify Console
   - Redeploy if needed

## Step 4: End-to-End Testing

### 4.1 Test Authentication Flow

1. Visit your Amplify URL
2. Try to login with:
   - Email: `admin@freehold.com`
   - Password: `password123`
3. Verify successful login and token storage

### 4.2 Test File Operations

1. **Upload Test**:
   - Try uploading a small PDF file
   - Verify upload progress and success message

2. **List Test**:
   - Verify document list loads
   - Check pagination and filtering

3. **Category Test**:
   - Verify categories load in sidebar
   - Test category filtering

### 4.3 Test CORS and API Connectivity

Open browser developer tools and verify:
- No CORS errors in console
- API requests return proper responses
- Authentication headers are sent correctly

## Troubleshooting

### Common Issues

#### 1. CORS Errors
```
Access to fetch at 'https://api-gateway-url' from origin 'https://amplify-url' has been blocked by CORS policy
```

**Solution**:
- Verify API Gateway CORS configuration
- Check Lambda function CORS headers
- Ensure OPTIONS method is configured

#### 2. Lambda Function Errors
```
{"errorMessage": "Cannot find module 'express'"}
```

**Solution**:
- Verify deployment package includes node_modules
- Check Lambda handler is set to `index.handler`
- Verify runtime is Node.js 18.x

#### 3. Authentication Issues
```
401 Unauthorized
```

**Solution**:
- Check Lambda environment variables
- Verify JWT secret configuration
- Test authentication endpoint directly

#### 4. API Gateway 502 Errors
```
{"message": "Internal server error"}
```

**Solution**:
- Check Lambda function logs in CloudWatch
- Verify Lambda function permissions
- Test Lambda function directly

### Debugging Commands

```bash
# Check Lambda logs
aws logs describe-log-groups --log-group-name-prefix /aws/lambda/freehold-api

# Test Lambda function
aws lambda invoke --function-name freehold-api --payload '{}' response.json

# Test API Gateway endpoint
curl -X GET https://your-api-id.execute-api.us-east-1.amazonaws.com/prod/health

# Check CORS
curl -X OPTIONS \
  -H "Origin: https://your-amplify-url" \
  -H "Access-Control-Request-Method: POST" \
  -H "Access-Control-Request-Headers: Content-Type" \
  https://your-api-id.execute-api.us-east-1.amazonaws.com/prod/api/auth/login
```

## Security Considerations

### Production Checklist

- [ ] Change default JWT secrets in Lambda environment variables
- [ ] Restrict CORS origins to your actual domain
- [ ] Enable API Gateway throttling
- [ ] Set up CloudWatch monitoring and alarms
- [ ] Configure proper S3 bucket policies
- [ ] Enable AWS CloudTrail for audit logging
- [ ] Set up backup strategies for data

### Environment Variables to Update

**Critical** (must change in production):
- `JWT_SECRET`: Use a strong, unique secret (min 32 characters)
- `JWT_REFRESH_SECRET`: Use a different strong secret
- `S3_BUCKET_NAME`: Your actual S3 bucket name
- `CORS_ORIGIN`: Your actual domain(s)

**Optional** (can use defaults):
- `DB_*`: Database configuration (when you add database)
- `MAX_FILE_SIZE`: File upload limits
- `LOG_LEVEL`: Logging verbosity

## Monitoring and Maintenance

### CloudWatch Monitoring

Set up monitoring for:
- Lambda function errors and duration
- API Gateway 4xx/5xx errors
- S3 upload/download metrics
- Frontend error rates

### Regular Maintenance

- Monitor Lambda function logs
- Review API Gateway access logs
- Update dependencies regularly
- Monitor S3 storage costs
- Review and rotate JWT secrets

## Support

If you encounter issues:

1. Check the troubleshooting section above
2. Review CloudWatch logs for detailed error messages
3. Test each component individually (Lambda → API Gateway → Frontend)
4. Verify all environment variables are set correctly

The deployment should now be fully functional with proper API Gateway configuration, Lambda permissions, and frontend connectivity.